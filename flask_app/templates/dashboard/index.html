{% extends "base.html" %}

{% block title %}Dashboard - ETF/Stock Trading System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-light mb-4">
            <i class="bi bi-speedometer2 text-trading-blue"></i>
            Trading System Dashboard
        </h1>
    </div>
</div>

{% if error %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Error:</strong> {{ error }}
            <hr>
            <small>Please ensure the database is initialized and accessible.</small>
        </div>
    </div>
</div>
{% else %}

<!-- System Status Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card card-hover h-100">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Database</h6>
                    <span class="status-indicator {{ 'success' if status.database_connected else 'danger' }}" 
                          data-status="database"></span>
                </div>
                <p class="card-text h5 {{ 'text-trading-green' if status.database_connected else 'text-trading-red' }}">
                    {{ 'Connected' if status.database_connected else 'Disconnected' }}
                </p>
                <small class="text-muted">System Database</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card card-hover h-100">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Instruments</h6>
                    <i class="bi bi-graph-up text-trading-blue"></i>
                </div>
                <p class="card-text h4 text-trading-blue">{{ status.total_symbols }}</p>
                <small class="text-muted">ETFs & Stocks</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card card-hover h-100">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Open Positions</h6>
                    <i class="bi bi-pie-chart text-trading-yellow"></i>
                </div>
                <p class="card-text h4 text-trading-yellow">{{ status.open_positions }}</p>
                <small class="text-muted">Active Trades</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card card-hover h-100">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Total Trades</h6>
                    <i class="bi bi-journal-text text-trading-green"></i>
                </div>
                <p class="card-text h4 text-trading-green">{{ status.total_trades }}</p>
                <small class="text-muted">Historical Trades</small>
            </div>
        </div>
    </div>
</div>

<!-- Market Regime Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-thermometer-half text-trading-blue"></i>
                    Current Market Regime
                </h5>
                <small class="text-muted">Live Analysis</small>
            </div>
            <div class="card-body">
                {% if regime.error %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        {{ regime.error }}
                    </div>
                {% else %}
                    <div class="row">
                        {% for key, data in regime.items() if key != 'error' %}
                        <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
                            <div class="text-center">
                                <strong class="text-light">{{ key.replace('_', ' ').title() }}</strong><br>
                                <span class="badge regime-badge regime-{{ data.value }}" 
                                      data-regime="{{ key }}">{{ data.label }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if not regime %}
                    <div class="text-center text-muted">
                        <i class="bi bi-clock"></i>
                        Regime analysis loading...
                    </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Data Cache and Quick Actions Row -->
<div class="row mb-4">
    <!-- Cache Statistics -->
    <div class="col-lg-8 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-database text-trading-green"></i>
                    Data Cache Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 mb-3">
                        <div class="border-end border-secondary">
                            <h4 class="text-trading-blue">{{ cache_stats.total_symbols }}</h4>
                            <small class="text-muted">Cached Symbols</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="border-end border-secondary">
                            <h4 class="text-trading-green">{{ '{:,}'.format(cache_stats.total_records) }}</h4>
                            <small class="text-muted">Price Records</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="border-end border-secondary">
                            <h4 class="text-trading-yellow">{{ '{:,}'.format(cache_stats.total_indicators) }}</h4>
                            <small class="text-muted">Indicators</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <h4 class="text-trading-green">{{ cache_stats.cache_hit_rate }}</h4>
                        <small class="text-muted">Hit Rate</small>
                    </div>
                </div>
                
                <!-- Cache Health Indicator -->
                <div class="mt-3 text-center">
                    <span class="status-indicator {{ 'success' if status.cache_healthy else 'danger' }}" 
                          data-status="cache"></span>
                    <span class="{{ 'text-trading-green' if status.cache_healthy else 'text-trading-red' }}">
                        Cache {{ 'Healthy' if status.cache_healthy else 'Unhealthy' }}
                    </span>
                    <span class="mx-2">|</span>
                    <span class="status-indicator {{ 'success' if status.data_fresh else 'warning' }}" 
                          data-status="data"></span>
                    <span class="{{ 'text-trading-green' if status.data_fresh else 'text-trading-yellow' }}">
                        Data {{ 'Fresh' if status.data_fresh else 'Stale' }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="col-lg-4 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning text-trading-yellow"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('screener.index') }}" class="btn btn-outline-primary btn-hover">
                        <i class="bi bi-search"></i> Run Screener
                    </a>
                    <a href="{{ url_for('data.index') }}" class="btn btn-outline-success btn-hover">
                        <i class="bi bi-arrow-clockwise"></i> Update Data
                    </a>
                    <a href="{{ url_for('journal.index') }}" class="btn btn-outline-info btn-hover">
                        <i class="bi bi-journal-text"></i> View Journal
                    </a>
                    <a href="{{ url_for('regime.index') }}" class="btn btn-outline-warning btn-hover">
                        <i class="bi bi-thermometer-half"></i> Regime Analysis
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Trades -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history text-trading-green"></i>
                    Recent Trades
                </h5>
                <a href="{{ url_for('journal.index') }}" class="btn btn-sm btn-outline-primary">
                    View All Trades
                </a>
            </div>
            <div class="card-body">
                {% if recent_trades %}
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Symbol</th>
                                <th>Setup</th>
                                <th>Entry Date</th>
                                <th>Entry Price</th>
                                <th>Exit Price</th>
                                <th>R Multiple</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trade in recent_trades %}
                            <tr>
                                <td>{{ trade.id }}</td>
                                <td>
                                    <strong class="text-trading-blue">{{ trade.symbol }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ trade.setup.replace('_', ' ').title() }}</span>
                                </td>
                                <td>{{ trade.entry_date or '-' }}</td>
                                <td>
                                    {% if trade.entry_price %}
                                        ${{ "%.2f"|format(trade.entry_price) }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if trade.exit_price %}
                                        ${{ "%.2f"|format(trade.exit_price) }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if trade.r_actual %}
                                        <span class="{{ 'text-trading-green' if trade.r_actual > 0 else 'text-trading-red' }}">
                                            {{ "%.2f"|format(trade.r_actual) }}R
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge {{ 'bg-warning' if trade.status == 'Open' else 'bg-success' }}">
                                        {{ trade.status }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-inbox display-4"></i>
                    <p class="mt-2">No trades found in the system</p>
                    <a href="{{ url_for('journal.index') }}" class="btn btn-outline-primary">
                        Add Your First Trade
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Dashboard-specific JavaScript

// Auto-refresh dashboard every minute
let dashboardRefreshInterval;

document.addEventListener('DOMContentLoaded', function() {
    console.log('📊 Dashboard loaded');
    
    // Start auto-refresh
    startDashboardRefresh();
});

function startDashboardRefresh() {
    dashboardRefreshInterval = setInterval(async function() {
        try {
            const response = await fetch('/api/status');
            const data = await response.json();
            
            if (data.success) {
                updateDashboardData(data);
                console.log('✅ Dashboard refreshed');
            }
        } catch (error) {
            console.error('❌ Dashboard refresh failed:', error);
        }
    }, 60000); // 1 minute
}

function updateDashboardData(data) {
    // Update status indicators
    if (data.status) {
        updateStatusIndicators(data.status);
    }
    
    // Update regime badges
    if (data.regime) {
        updateRegimeBadges(data.regime);
    }
    
    // Update timestamp
    document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
}

function updateStatusIndicators(status) {
    const indicators = {
        'database': status.database_connected,
        'cache': status.cache_healthy,
        'data': status.data_fresh
    };
    
    Object.entries(indicators).forEach(([key, value]) => {
        const indicator = document.querySelector(`[data-status="${key}"]`);
        if (indicator) {
            // Update indicator class
            indicator.className = `status-indicator ${value ? 'success' : 'danger'}`;
        }
    });
    
    // Update text values
    const dbText = document.querySelector('.card-text:contains("Connected"), .card-text:contains("Disconnected")');
    if (dbText) {
        dbText.textContent = status.database_connected ? 'Connected' : 'Disconnected';
        dbText.className = `card-text h5 ${status.database_connected ? 'text-trading-green' : 'text-trading-red'}`;
    }
}

function updateRegimeBadges(regime) {
    Object.entries(regime).forEach(([key, data]) => {
        const badge = document.querySelector(`[data-regime="${key}"]`);
        if (badge && data.label) {
            badge.textContent = data.label;
            badge.className = `badge regime-badge regime-${data.value}`;
        }
    });
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (dashboardRefreshInterval) {
        clearInterval(dashboardRefreshInterval);
    }
});
</script>
{% endblock %}